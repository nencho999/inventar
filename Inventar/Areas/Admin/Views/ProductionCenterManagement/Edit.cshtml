@using Inventar.Data.Models
@using Inventar.Web.ViewModels.ProductionCenter
@using Microsoft.AspNetCore.Mvc.Localization
@inject IViewLocalizer Localizer
@model CenterEditFormModel

@{
    ViewData["Title"] = Localizer["Edit Production Center"];
}

<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />

<h2 class="d-flex align-items-center mb-4 text-warning fw-bold">
    <i class="fas fa-edit me-3"></i> @Localizer["Editing:"] @Model.Name
</h2>
<hr />

<div class="row">
    <div class="col-md-11">
        <form asp-action="Edit" method="post" class="shadow-sm p-4 bg-white rounded border">
            <div asp-validation-summary="ModelOnly" class="alert alert-danger shadow-sm"></div>

            <input type="hidden" asp-for="Id" />

            <h5 class="text-warning mb-3 fw-bold"><i class="fas fa-file-alt me-2"></i> @Localizer["General Information"]</h5>

            @* 1. Име и Статус *@
            <div class="row">
                <div class="col-md-6 mb-3">
                    <div class="input-group shadow-sm">
                        <span class="input-group-text bg-light text-warning"><i class="fas fa-warehouse"></i></span>
                        <div class="form-floating flex-grow-1">
                            <input asp-for="Name" class="form-control" placeholder="@Localizer["Name"]" />
                            <label asp-for="Name">@Localizer["Name"]</label>
                        </div>
                    </div>
                </div>
                <div class="col-md-6 mb-3">
                    <div class="input-group shadow-sm">
                        <span class="input-group-text bg-light text-warning"><i class="fas fa-toggle-on"></i></span>
                        <div class="form-floating flex-grow-1">
                            <select asp-for="Status" asp-items="ViewBag.CenterStatuses" class="form-select">
                            </select>
                            <label asp-for="Status">@Localizer["Status"]</label>
                        </div>
                    </div>
                </div>
            </div>

            @* 2. Локация, Общ Капацитет и Разходи *@
            <div class="row mb-3">
                <div class="col-md-4">
                    <div class="input-group shadow-sm">
                        <span class="input-group-text bg-light text-warning"><i class="fas fa-map-marker-alt"></i></span>
                        <div class="form-floating flex-grow-1">
                            <input asp-for="Location" class="form-control" placeholder="@Localizer["Location"]" />
                            <label asp-for="Location">@Localizer["Location"]</label>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="input-group shadow-sm">
                        <span class="input-group-text bg-light text-warning"><i class="fas fa-industry"></i></span>
                        <div class="form-floating flex-grow-1">
                            <input asp-for="Capacity" class="form-control" placeholder="@Localizer["Capacity"]" />
                            <label asp-for="Capacity">@Localizer["Capacity"]</label>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="input-group shadow-sm">
                        <span class="input-group-text bg-light text-warning"><i class="fas fa-coins"></i></span>
                        <div class="form-floating flex-grow-1">
                            <input asp-for="Expenses" class="form-control" placeholder="500" />
                            <label asp-for="Expenses">@Localizer["General Expenses"]</label>
                        </div>
                        <span class="input-group-text">€</span>
                    </div>
                </div>
            </div>

            <div class="mb-3 input-group shadow-sm">
                <span class="input-group-text bg-light text-warning"><i class="fas fa-phone"></i></span>
                <div class="form-floating flex-grow-1">
                    <input asp-for="Contact" class="form-control" placeholder="@Localizer["Contact"]" />
                    <label asp-for="Contact">@Localizer["Contact Information"]</label>
                </div>
            </div>

            <hr class="my-4 opacity-25" />

            @* 3. Складов капацитет и ТЕКУЩА НАЛИЧНОСТ *@
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="text-warning mb-0 fw-bold"><i class="fas fa-boxes me-2"></i> @Localizer["Storage Capacity by Product"]</h5>
                <button type="button" class="btn btn-outline-warning btn-sm px-4 rounded-pill shadow-sm fw-bold" onclick="addStorageRow()">
                    <i class="fas fa-plus-circle me-1"></i> @Localizer["Add Product"]
                </button>
            </div>

            <div id="storage-container" class="mb-4">
                @for (int i = 0; i < Model.Storages.Count; i++)
                {
                    <div class="row mb-3 align-items-center g-2 p-3 border rounded bg-light mx-0 storage-row shadow-sm position-relative">
                        <div class="col-md-5">
                            <label class="small fw-bold text-muted mb-1 d-block">@Localizer["Product"]</label>
                            <select name="Storages[@i].MaterialId" class="form-select product-search-select" required>
                                @foreach (var mat in Model.Products)
                                {
                                    <option value="@mat.Id" selected="@(mat.Id == Model.Storages[i].MaterialId ? "selected" : null)">@mat.Name</option>
                                }
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="small fw-bold text-muted mb-1 d-block">@Localizer["Current Stock"]</label>
                            <input name="Storages[@i].CurrentStock" type="number" step="0.01" class="form-control text-warning fw-bold" value="@Model.Storages[i].CurrentStock" required />
                        </div>
                        <div class="col-md-3">
                            <label class="small fw-bold text-muted mb-1 d-block">@Localizer["Max Capacity"]</label>
                            <div class="input-group shadow-sm">
                                <input name="Storages[@i].MaxCapacity" type="number" step="0.01" class="form-control" value="@Model.Storages[i].MaxCapacity" required />
                                <span class="input-group-text small bg-light">QTY</span>
                            </div>
                        </div>
                        <div class="col-md-2 text-end pt-4">
                            <button type="button" class="btn btn-outline-danger btn-sm border-0" onclick="this.closest('.storage-row').remove()">
                                <i class="fas fa-trash-alt fa-lg"></i>
                            </button>
                        </div>
                    </div>
                }
            </div>

            <hr class="my-4 opacity-25" />

            @* 4. Динамичен списък с Разходи *@
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="text-warning mb-0 fw-bold"><i class="fas fa-receipt me-2"></i> @Localizer["Expenses Management"]</h5>
                <button type="button" class="btn btn-outline-warning btn-sm px-4 rounded-pill shadow-sm fw-bold" onclick="addExpenseRow()">
                    <i class="fas fa-plus-circle me-1"></i> @Localizer["Add Expense"]
                </button>
            </div>

            <div id="expense-container" class="mb-4">
                @for (int i = 0; i < Model.ExpensesList.Count; i++)
                {
                    <div class="card mb-3 p-3 expense-row shadow-sm border-light bg-white">
                        <div class="row g-2 align-items-center">
                            <div class="col-md-4">
                                <label class="small fw-bold text-muted mb-1 d-block">@Localizer["Expense Name"]</label>
                                <input name="ExpensesList[@i].Name" class="form-control" value="@Model.ExpensesList[i].Name" required />
                            </div>
                            <div class="col-md-3">
                                <label class="small fw-bold text-muted mb-1 d-block">@Localizer["Amount"]</label>
                                <div class="input-group shadow-sm">
                                    <input name="ExpensesList[@i].Amount" type="number" step="0.01" class="form-control" value="@Model.ExpensesList[i].Amount" required />
                                    <span class="input-group-text bg-light">€</span>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <label class="small fw-bold text-muted mb-1 d-block">@Localizer["Type"]</label>
                                <select name="ExpensesList[@i].Type" class="form-select" onchange="toggleExpenseFields(this, @i)">
                                    <option value="0" selected="@(Model.ExpensesList[i].Type == ExpenseType.OneTime)">@Localizer["One-time"]</option>
                                    <option value="1" selected="@(Model.ExpensesList[i].Type == ExpenseType.Regular)">@Localizer["Regular"]</option>
                                </select>
                            </div>
                            <div class="col-md-2 text-end pt-4">
                                <button type="button" class="btn btn-outline-danger btn-sm border-0" onclick="this.closest('.expense-row').remove()">
                                    <i class="fas fa-trash-alt fa-lg"></i>
                                </button>
                            </div>
                        </div>

                        <div id="expense-details-@i" class="mt-2 row g-2">
                            @if (Model.ExpensesList[i].Type == ExpenseType.OneTime)
                            {
                                <div class="col-md-4">
                                    <label class="small fw-bold text-muted">@Localizer["Date"]</label>
                                    <input name="ExpensesList[@i].Date" type="date" class="form-control" value="@Model.ExpensesList[i].Date?.ToString("yyyy-MM-dd")" required />
                                </div>
                            }
                            else
                            {
                                <div class="col-md-4">
                                    <label class="small fw-bold text-muted">@Localizer["Frequency"]</label>
                                    <select name="ExpensesList[@i].Frequency" class="form-select" onchange="toggleCustomMonths(this, @i)">
                                        <option value="0" selected="@(Model.ExpensesList[i].Frequency == Frequency.Weekly)">@Localizer["Weekly"]</option>
                                        <option value="1" selected="@(Model.ExpensesList[i].Frequency == Frequency.Monthly)">@Localizer["Monthly"]</option>
                                        <option value="2" selected="@(Model.ExpensesList[i].Frequency == Frequency.Yearly)">@Localizer["Yearly"]</option>
                                        <option value="3" selected="@(Model.ExpensesList[i].Frequency == Frequency.CustomMonths)">@Localizer["Every X months"]</option>
                                    </select>
                                </div>
                                <div id="custom-months-container-@i" class="col-md-3 @(Model.ExpensesList[i].Frequency == Frequency.CustomMonths ? "" : "d-none")">
                                    <label class="small fw-bold text-muted">@Localizer["Months Interval"]</label>
                                    <input name="ExpensesList[@i].EveryXMonths" type="number" class="form-control text-warning fw-bold" value="@Model.ExpensesList[i].EveryXMonths" />
                                </div>
                            }
                        </div>
                    </div>
                }
            </div>

            <div class="d-flex justify-content-end mt-5 border-top pt-4">
                <a asp-action="Index" class="btn btn-link text-muted me-3 text-decoration-none px-4">@Localizer["Cancel"]</a>
                <button type="submit" class="btn btn-warning px-5 shadow text-dark fw-bold">
                    <i class="fas fa-save me-2"></i> @Localizer["Save Changes"]
                </button>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <script>
        let storageIndex = @Model.Storages.Count;
        let expenseIndex = @Model.ExpensesList.Count;

        const availableMaterials = @Html.Raw(Json.Serialize(Model.Products));

        const translations = {
            selectProduct: "@Localizer["-- Search & Select Product --"]",
            maxCapacity: "@Localizer["Max Capacity"]",
            currentStock: "@Localizer["Current Stock"]",
            expenseName: "@Localizer["Expense Name"]",
            amount: "@Localizer["Amount"]",
            oneTime: "@Localizer["One-time"]",
            regular: "@Localizer["Regular"]",
            weekly: "@Localizer["Weekly"]",
            monthly: "@Localizer["Monthly"]",
            yearly: "@Localizer["Yearly"]",
            everyXMonths: "@Localizer["Every X months"]",
            date: "@Localizer["Date"]",
            frequency: "@Localizer["Frequency"]",
            monthsInterval: "@Localizer["Months Interval"]",
            product: "@Localizer["Product"]"
        };

        $(document).ready(function() {
            $('.product-search-select').select2({
                placeholder: translations.selectProduct,
                allowClear: true,
                width: '100%'
            });
        });

        function addStorageRow() {
            const container = document.getElementById('storage-container');
            const selectId = `product-select-${storageIndex}`;
            const row = document.createElement('div');
            row.className = 'row mb-3 align-items-center g-2 p-3 border rounded bg-light mx-0 storage-row shadow-sm';

            let optionsHtml = `<option value="">${translations.selectProduct}</option>`;
            availableMaterials.forEach(mat => {
                optionsHtml += `<option value="${mat.id}">${mat.name}</option>`;
            });

            row.innerHTML = `
                <div class="col-md-5">
                    <label class="small fw-bold text-muted mb-1 d-block">${translations.product}</label>
                    <select id="${selectId}" name="Storages[${storageIndex}].MaterialId" class="form-select" required>${optionsHtml}</select>
                </div>
                <div class="col-md-2">
                    <label class="small fw-bold text-muted mb-1 d-block">${translations.currentStock}</label>
                    <input name="Storages[${storageIndex}].CurrentStock" type="number" step="0.01" class="form-control text-warning fw-bold" value="0" required />
                </div>
                <div class="col-md-3">
                    <label class="small fw-bold text-muted mb-1 d-block">${translations.maxCapacity}</label>
                    <div class="input-group">
                        <input name="Storages[${storageIndex}].MaxCapacity" type="number" step="0.01" class="form-control" placeholder="0.00" required />
                        <span class="input-group-text small bg-light">QTY</span>
                    </div>
                </div>
                <div class="col-md-2 text-end pt-4">
                    <button type="button" class="btn btn-outline-danger btn-sm border-0" onclick="this.closest('.storage-row').remove()">
                        <i class="fas fa-trash-alt fa-lg"></i>
                    </button>
                </div>`;

            container.appendChild(row);
            $(`#${selectId}`).select2({ width: '100%' });
            storageIndex++;
        }

        function addExpenseRow() {
            const container = document.getElementById('expense-container');
            const row = document.createElement('div');
            row.className = 'card mb-3 p-3 expense-row shadow-sm border-light bg-white';

            row.innerHTML = `
                <div class="row g-2 align-items-center">
                    <div class="col-md-4">
                        <label class="small fw-bold text-muted mb-1 d-block">${translations.expenseName}</label>
                        <input name="ExpensesList[${expenseIndex}].Name" class="form-control" required />
                    </div>
                    <div class="col-md-3">
                        <label class="small fw-bold text-muted mb-1 d-block">${translations.amount}</label>
                        <div class="input-group shadow-sm">
                            <input name="ExpensesList[${expenseIndex}].Amount" type="number" step="0.01" class="form-control" required />
                            <span class="input-group-text bg-light">€</span>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <label class="small fw-bold text-muted mb-1 d-block">@Localizer["Type"]</label>
                        <select name="ExpensesList[${expenseIndex}].Type" class="form-select" onchange="toggleExpenseFields(this, ${expenseIndex})">
                            <option value="0">${translations.oneTime}</option>
                            <option value="1">${translations.regular}</option>
                        </select>
                    </div>
                    <div class="col-md-2 text-end pt-4">
                        <button type="button" class="btn btn-outline-danger btn-sm border-0" onclick="this.closest('.expense-row').remove()">
                            <i class="fas fa-trash-alt fa-lg"></i>
                        </button>
                    </div>
                </div>
                <div id="expense-details-${expenseIndex}" class="mt-2 row g-2">
                    <div class="col-md-4">
                        <label class="small fw-bold text-muted">${translations.date}</label>
                        <input name="ExpensesList[${expenseIndex}].Date" type="date" class="form-control" required />
                    </div>
                </div>`;
            container.appendChild(row);
            expenseIndex++;
        }

        function toggleExpenseFields(select, index) {
            const detailsDiv = document.getElementById(`expense-details-${index}`);
            if (select.value === "0") {
                detailsDiv.innerHTML = `
                    <div class="col-md-4">
                        <label class="small fw-bold text-muted">${translations.date}</label>
                        <input name="ExpensesList[${index}].Date" type="date" class="form-control" required />
                    </div>`;
            } else {
                detailsDiv.innerHTML = `
                    <div class="col-md-4">
                        <label class="small fw-bold text-muted">${translations.frequency}</label>
                        <select name="ExpensesList[${index}].Frequency" class="form-select" onchange="toggleCustomMonths(this, ${index})">
                            <option value="0">${translations.weekly}</option>
                            <option value="1">${translations.monthly}</option>
                            <option value="2">${translations.yearly}</option>
                            <option value="3">${translations.everyXMonths}</option>
                        </select>
                    </div>
                    <div id="custom-months-container-${index}" class="col-md-3 d-none">
                        <label class="small fw-bold text-muted">${translations.monthsInterval}</label>
                        <input name="ExpensesList[${index}].EveryXMonths" type="number" class="form-control text-warning fw-bold" />
                    </div>`;
            }
        }

        function toggleCustomMonths(select, index) {
            const container = document.getElementById(`custom-months-container-${index}`);
            select.value === "3" ? container.classList.remove('d-none') : container.classList.add('d-none');
        }
    </script>

    <style>
        .select2-container--default .select2-selection--single {
            border: 1px solid #dee2e6;
            height: 3.5rem;
            padding-top: 1rem;
        }

            .select2-container--default .select2-selection--single .select2-selection__arrow {
                height: 3.4rem;
            }

        .storage-row:hover {
            border-color: #ffc107 !important;
            background-color: #fff !important;
        }

        .form-floating > .form-control:focus, .form-floating > .form-control:not(:placeholder-shown) {
            padding-top: 1.625rem;
            padding-bottom: 0.625rem;
        }
    </style>
}