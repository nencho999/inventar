@using Inventar.Web.ViewModels.ProductionCenter
@using Inventar.Data.Models
@using Microsoft.AspNetCore.Mvc.Localization
@model IEnumerable<CenterIndexViewModel>
@inject IViewLocalizer Localizer

@{
    ViewData["Title"] = Localizer["Production Centers Dashboard"];
    Layout = "~/Views/Shared/_Layout.cshtml";

    var activeCenters = Model.Where(c => c.Status.HasValue).ToList();

    var statusSummary = activeCenters.GroupBy(c => c.Status).Select(g => new
    {
        Status = g.Key.ToString(),
        Count = g.Count()
    }).ToList();

    var totalCenters = activeCenters.Count();

    // 1. КАЛКУЛАЦИЯ НА МЕСЕЧНИТЕ РАЗХОДИ (от string полето)
    decimal totalMonthlyExpenses = Model
        .Where(c => !string.IsNullOrWhiteSpace(c.Expenses))
        .Select(c => {
            decimal val;
            string cleanValue = c.Expenses.Replace("€", "").Replace("$", "").Trim();
            return decimal.TryParse(cleanValue, out val) ? val : 0;
        })
        .Sum();

    decimal totalOneTimeExpenses = Model
        .Where(c => c.ExpensesList != null)
        .SelectMany(c => c.ExpensesList)
        .Where(e => e.Type == ExpenseType.OneTime)
        .Sum(e => e.Amount);

    Func<string, string> GetStatusClass = (status) => status switch
    {
        "Operational" => "bg-success",
        "Maintenance" => "bg-warning text-dark",
        "UnderConstruction" => "bg-warning text-dark",
        "Closed" => "bg-danger",
        _ => "bg-secondary"
    };
    
    string GetModalId(Guid id) => $"detailsModal_{id}";
}

<h1 class="h3 mb-4">
    <i class="fas fa-industry text-primary me-2"></i> @ViewData["Title"]
</h1>
<hr />

<div class="row mb-5">
    @* Карта: Общи месечни разходи *@
    <div class="col-md-3 mb-3">
        <div class="card bg-danger text-white shadow">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-auto">
                        <i class="fas fa-calendar-check fa-2x"></i>
                    </div>
                    <div class="col">
                        <div class="text-xs font-weight-bold text-uppercase mb-1">
                            @Localizer["Monthly Expenses"]
                        </div>
                        <div class="h5 mb-0 font-weight-bold">@totalMonthlyExpenses.ToString("F2") €</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    @* Карта: Общи еднократни разходи *@
    <div class="col-md-3 mb-3">
        <div class="card bg-warning text-dark shadow">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-auto">
                        <i class="fas fa-receipt fa-2x"></i>
                    </div>
                    <div class="col">
                        <div class="text-xs font-weight-bold text-uppercase mb-1">
                            @Localizer["One-time Expenses"]
                        </div>
                        <div class="h5 mb-0 font-weight-bold">@totalOneTimeExpenses.ToString("F2") €</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    @* Карта: Общо активни центрове *@
    <div class="col-md-3 mb-3">
        <div class="card bg-info text-white shadow">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-auto">
                        <i class="fas fa-globe-americas fa-2x"></i>
                    </div>
                    <div class="col">
                        <div class="text-xs font-weight-bold text-uppercase mb-1">
                            @Localizer["Total Active Centers"]
                        </div>
                        <div class="h5 mb-0 font-weight-bold">@totalCenters</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    @foreach (var summary in statusSummary)
    {
        string badgeClass = GetStatusClass(summary.Status);

        <div class="col-md-3 mb-3">
            <div class="card @badgeClass text-white shadow">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-auto">
                            <i class="fas fa-tachometer-alt fa-2x"></i>
                        </div>
                        <div class="col">
                            <div class="text-xs font-weight-bold text-uppercase mb-1">@Localizer[summary.Status]</div>
                            <div class="h5 mb-0 font-weight-bold">@summary.Count</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

<div class="d-flex justify-content-end align-items-center gap-2 mb-4">
    @* БУТОН ЗА ПРОДУКТИ *@
    <a asp-controller="Product" asp-action="Index" class="btn btn-outline-primary d-flex align-items-center shadow-sm">
        <i class="fas fa-boxes me-2"></i> @Localizer["Product Catalog"]
    </a>

    @* БУТОН ЗА НОВ ЦЕНТЪР *@
    <a asp-action="Create" class="btn btn-primary px-4 fw-bold">
        <i class="fas fa-plus-circle me-1"></i> @Localizer["Add New Center"]
    </a>
</div>

@if (Model.Any())
{
    <div class="row">
        @foreach (var center in Model)
        {
            bool isStatusDefined = center.Status.HasValue;
            string statusString = isStatusDefined ? center.Status.ToString() : "";
            string statusBgClass = GetStatusClass(statusString);
            string statusBadgeClass = $"badge {statusBgClass}";

            <div class="col-md-4 mb-4">
                <div class="card h-100 shadow-sm">
                    <div class="card-header bg-light">
                        <h5 class="card-title mb-0 text-primary">
                            <i class="fas fa-warehouse me-2"></i> @center.Name
                        </h5>
                    </div>

                    <div class="card-body d-flex flex-column">

                        <div class="mb-3">
                            <small class="text-muted">@Localizer["Current Status:"]</small><br />
                             @if (isStatusDefined)
                            {
                                <span class="@statusBadgeClass">@Localizer[center.Status.ToString()]</span>
                            }
                            else
                            {
                                <span class="badge bg-danger">@Localizer["Status: Not defined"]</span>
                            }
                        </div>

                        <div class="mb-3">
                            <p class="card-text mb-1"><i class="fas fa-map-marker-alt me-2 text-secondary"></i> 
                                <strong>@Localizer["Location:"]</strong> @center.Location
                            </p>
                            <p class="card-text mb-1"><i class="fas fa-tools me-2 text-secondary"></i> 
                                <strong>@Localizer["Capacity:"]</strong> @center.Capacity
                            </p>
                            <p class="card-text mb-1"><i class="fas fa-phone-alt me-2 text-secondary"></i> 
                                <strong>@Localizer["Contact:"]</strong> @center.Contact
                            </p>
                            <p class="card-text mb-1"><i class="fas fa-money-bill-wave me-2 text-secondary"></i> 
                                <strong>@Localizer["Expenses:"]</strong> @center.Expenses €
                            </p>
                        </div>

                        <div class="mt-auto pt-2 border-top">
                            <button type="button" class="btn btn-sm btn-outline-primary w-100 mb-2" data-bs-toggle="modal" data-bs-target="#@GetModalId(center.Id)">
                                <i class="fas fa-info-circle"></i> @Localizer["View Full Details"]
                            </button>
                            <div class="d-flex justify-content-between">
                                @* ПРОМЕНЕН БУТОН: btn-warning за оранжев цвят *@
                                <a asp-action="Edit" asp-route-id="@center.Id" class="btn btn-sm btn-warning text-dark shadow-sm flex-fill me-2">
                                    <i class="fas fa-edit"></i> @Localizer["Edit"]
                                </a>
                                <a asp-action="Delete" asp-route-id="@center.Id" class="btn btn-sm btn-danger shadow-sm flex-fill">
                                    <i class="fas fa-trash-alt"></i> @Localizer["Remove"]
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="modal fade" id="@GetModalId(center.Id)" tabindex="-1" aria-labelledby="detailsModalLabel_@center.Id" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header @(isStatusDefined && center.Status.ToString() == "Operational" ? "bg-success text-white" : "bg-primary text-white")">
                            <h5 class="modal-title" id="detailsModalLabel_@center.Id">@center.Name - @Localizer["Details"]</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <p>
                                <strong><i class="fas fa-exclamation-triangle me-2"></i> @Localizer["Current Status:"]</strong>
                                @if (isStatusDefined)
                                {
                                    <span class="@statusBadgeClass">@Localizer[center.Status.ToString()]</span>
                                }
                                else
                                {
                                    <span class="badge bg-danger">@Localizer["Status: Not defined"]</span>
                                }
                            </p>
                            <p><strong><i class="fas fa-map-marked-alt me-2"></i> @Localizer["Location:"]</strong> @center.Location</p>
                            <p><strong><i class="fas fa-cogs me-2"></i> @Localizer["Capacity:"]</strong> @center.Capacity</p>
                            <p><strong><i class="fas fa-phone-alt me-2"></i> @Localizer["Contact:"]</strong> @center.Contact</p> 
                            <p><strong><i class="fas fa-money-bill-wave me-2"></i> @Localizer["Expenses:"]</strong> @center.Expenses €</p>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">@Localizer["Close"]</button>
                        </div>
                    </div>
                </div>
            </div>
        }
    </div>
}
else
{
    <div class="alert alert-info shadow-sm">
        <i class="fas fa-box-open me-2"></i> @Localizer["No production centers have been registered yet."]
    </div>
}