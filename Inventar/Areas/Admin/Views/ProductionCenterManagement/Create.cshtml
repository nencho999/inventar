@using Inventar.Data.Models
@using Inventar.Web.ViewModels.ProductionCenter
@using System.Text.Encodings.Web
@using Microsoft.AspNetCore.Mvc.Localization
@model CenterCreateInputModel
@inject IViewLocalizer Localizer

@{
    ViewData["Title"] = Localizer["Register New Production Center"];
}

<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />

<h2 class="d-flex align-items-center mb-4">
    <i class="fas fa-plus-circle me-3 text-success"></i> @ViewData["Title"]
</h2>
<hr />

<div class="row">
    <div class="col-md-11">
        <form asp-action="Create" method="post" class="shadow p-4 bg-white rounded">
            <div asp-validation-summary="ModelOnly" class="alert alert-danger"></div>

            <h5 class="text-primary mb-3"><i class="fas fa-file-alt me-2"></i> @Localizer["General Information"]</h5>

            <div class="row">
                <div class="col-md-6 mb-3">
                    <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-warehouse"></i></span>
                        <div class="form-floating flex-grow-1">
                            <input asp-for="Name" class="form-control" placeholder="Name" />
                            <label asp-for="Name">@Localizer["Name"]</label>
                        </div>
                        <span class="input-group-text text-danger">*</span>
                    </div>
                    <span asp-validation-for="Name" class="text-danger"></span>
                </div>
                <div class="col-md-6 mb-3">
                    <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-exclamation-triangle"></i></span>
                        <div class="form-floating flex-grow-1">
                            <select asp-for="Status" asp-items="ViewBag.CenterStatuses" class="form-select">
                                <option value="">@Localizer["Non-defined"]</option>
                            </select>
                            <label asp-for="Status">@Localizer["Status"]</label>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row mb-3">
                <div class="col-md-4">
                    <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-map-marker-alt"></i></span>
                        <input asp-for="Location" class="form-control" placeholder="@Localizer["Location"]" />
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-industry"></i></span>
                        <input asp-for="Capacity" class="form-control" placeholder="@Localizer["Capacity"]" />
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-phone"></i></span>
                        <input asp-for="Contact" class="form-control" placeholder="@Localizer["Contact"]" />
                    </div>
                </div>
            </div>

            <hr class="my-4" />

            @* STORAGE CAPACITY SECTION С ТЪРСАЧКА *@
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="text-primary mb-0">
                    <i class="fas fa-database me-2"></i> @Localizer["Storage Capacity by Product"]
                </h5>
                <button type="button" class="btn btn-outline-primary btn-sm px-3" onclick="addStorageRow()">
                    <i class="fas fa-plus-circle me-1"></i> @Localizer["Add Product"]
                </button>
            </div>

            <div id="storage-container" class="mb-4">
                <div class="text-muted small mb-2 p-3 border rounded bg-light text-center" id="no-storage-msg">
                    <i class="fas fa-info-circle me-1"></i> @Localizer["No storage capacities defined. Click 'Add Product' to start."]
                </div>
            </div>

            <hr class="my-4" />

            @* EXPENSES SECTION *@
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="text-primary mb-0">
                    <i class="fas fa-money-bill-wave me-2"></i> @Localizer["Expenses Management"]
                </h5>
                <button type="button" class="btn btn-outline-success btn-sm px-3" onclick="addExpenseRow()">
                    <i class="fas fa-plus-circle me-1"></i> @Localizer["Add Expense"]
                </button>
            </div>

            <div id="expense-container" class="mb-4">
                <div class="text-muted small mb-2 p-3 border rounded bg-light text-center" id="no-expenses-msg">
                    <i class="fas fa-info-circle me-1"></i> @Localizer["No expenses added yet."]
                </div>
            </div>

            <div class="d-flex justify-content-end mt-5 border-top pt-4">
                <a asp-action="Index" class="btn btn-secondary px-4 me-2 shadow-sm">@Localizer["Cancel"]</a>
                <button type="submit" class="btn btn-success px-5 shadow-sm">
                    <i class="fas fa-save me-2"></i> @Localizer["Save Center"]
                </button>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <script>
        let storageIndex = 0;
        let expenseIndex = 0;

        // Преименуваме MaterialId на ProductId за консистенция
        const availableProducts = @Html.Raw(Json.Serialize(Model.Products));

        const translations = {
            selectProduct: "@Localizer["-- Search & Select Product --"]",
            maxCapacity: "@Localizer["Max Capacity"]",
            expenseName: "@Localizer["Expense Name"]",
            amount: "@Localizer["Amount"]",
            oneTime: "@Localizer["One-time"]",
            regular: "@Localizer["Regular"]"
        };

        // --- Storage Logic with Search ---
        function addStorageRow() {
            document.getElementById('no-storage-msg')?.remove();

            const container = document.getElementById('storage-container');
            const rowId = `storage-row-${storageIndex}`;
            const selectId = `product-select-${storageIndex}`;

            const row = document.createElement('div');
            row.className = 'row mb-3 align-items-center g-2 p-3 border rounded bg-white shadow-sm mx-0';
            row.id = rowId;

            let optionsHtml = `<option value="">${translations.selectProduct}</option>`;
            availableProducts.forEach(p => {
                optionsHtml += `<option value="${p.id}">${p.name}</option>`;
            });

            row.innerHTML = `
                <div class="col-md-7">
                    <label class="small text-muted mb-1 d-block">@Localizer["Select Product"]</label>
                    <select id="${selectId}" name="Storages[${storageIndex}].MaterialId" class="form-select product-select" required>
                        ${optionsHtml}
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="small text-muted mb-1 d-block">@Localizer["Max Capacity"]</label>
                    <div class="input-group">
                        <input name="Storages[${storageIndex}].MaxCapacity" type="number" step="0.01" class="form-control" placeholder="0.00" required />
                        <span class="input-group-text small">QTY</span>
                    </div>
                </div>
                <div class="col-md-2 text-end pt-4">
                    <button type="button" class="btn btn-outline-danger btn-sm" onclick="this.closest('.row').remove()">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                </div>`;

            container.appendChild(row);

            // Инициализация на търсачката за новия ред
            $(`#${selectId}`).select2({
                placeholder: translations.selectProduct,
                allowClear: true,
                width: '100%'
            });

            storageIndex++;
        }

        // --- Expenses Logic ---
        function addExpenseRow() {
            document.getElementById('no-expenses-msg')?.remove();

            const container = document.getElementById('expense-container');
            const row = document.createElement('div');
            row.className = 'card mb-3 p-3 expense-row shadow-sm border-light bg-white';

            row.innerHTML = `
                <div class="row g-2 align-items-center">
                    <div class="col-md-4">
                        <label class="small text-muted mb-1 d-block">${translations.expenseName}</label>
                        <input name="ExpensesList[${expenseIndex}].Name" class="form-control" required />
                    </div>
                    <div class="col-md-3">
                        <label class="small text-muted mb-1 d-block">${translations.amount}</label>
                        <input name="ExpensesList[${expenseIndex}].Amount" type="number" step="0.01" class="form-control" required />
                    </div>
                    <div class="col-md-3">
                        <label class="small text-muted mb-1 d-block">@Localizer["Type"]</label>
                        <select name="ExpensesList[${expenseIndex}].Type" class="form-select" onchange="toggleExpenseType(this, ${expenseIndex})" required>
                            <option value="OneTime">${translations.oneTime}</option>
                            <option value="Regular">${translations.regular}</option>
                        </select>
                    </div>
                    <div class="col-md-2 text-end pt-4">
                        <button type="button" class="btn btn-outline-danger btn-sm" onclick="this.closest('.expense-row').remove()">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
                <div id="expense-details-${expenseIndex}" class="mt-2 row g-2">
                    <div class="col-md-4">
                        <label class="small text-muted">@Localizer["Date"]</label>
                        <input name="ExpensesList[${expenseIndex}].Date" type="date" class="form-control" required />
                    </div>
                </div>`;
            container.appendChild(row);
            expenseIndex++;
        }

        function toggleExpenseType(select, index) {
            const detailsDiv = document.getElementById(`expense-details-${index}`);
            if (select.value === "OneTime") {
                detailsDiv.innerHTML = `
                    <div class="col-md-4">
                        <label class="small text-muted">@Localizer["Date"]</label>
                        <input name="ExpensesList[${index}].Date" type="date" class="form-control" required />
                    </div>`;
            } else {
                detailsDiv.innerHTML = `
                    <div class="col-md-4">
                        <label class="small text-muted">@Localizer["Frequency"]</label>
                        <select name="ExpensesList[${index}].Frequency" class="form-select" required>
                            <option value="Weekly">@Localizer["Weekly"]</option>
                            <option value="Monthly">@Localizer["Monthly"]</option>
                            <option value="Yearly">@Localizer["Yearly"]</option>
                        </select>
                    </div>`;
            }
        }
    </script>

    <style>
        /* Стилизиране на Select2 за по-добра интеграция с Bootstrap */
        .select2-container--default .select2-selection--single {
            border: 1px solid #dee2e6;
            height: 38px;
            padding-top: 5px;
        }

            .select2-container--default .select2-selection--single .select2-selection__arrow {
                height: 36px;
            }

        .storage-row:hover {
            border-color: #0d6efd !important;
        }
    </style>
}